## 1. 数据库

> 使用 AI 构建通用数据表，提示语：

```plain
我要使用pg 18数据库创建一个表，有四个字段，分别是
id（uuidv7类型），
创建时间（带时区的时间戳），
更新时间（带时区的时间戳），
data（jsonb类型）；
然后创建一个触发器，自动更新表中的更新时间。
请你帮我写一下对应的sql语句。
```

AI 生成的 sql 示例如下：

```sql
-- 创建表
CREATE TABLE IF NOT EXISTS example_table (
    -- id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id UUID DEFAULT uuidv7() PRIMARY KEY,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    data JSONB
);

-- 创建触发器函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1
        FROM pg_trigger
        WHERE tgname = 'trigger_update_updated_at'
          AND tgrelid = 'example_table'::regclass
    ) THEN
        CREATE TRIGGER trigger_update_updated_at
            BEFORE UPDATE ON example_table
            FOR EACH ROW
            EXECUTE FUNCTION update_updated_at_column();
    END IF;
END $$;
```

使用时先批量修改 sql 中的表名 example_table, 比如表名为 template.

## 2. 创建 hono 项目

> 使用 node v20 以上版本

### 2.1 安装依赖

```shell
pnpm init

# 生产依赖
pnpm add hono @hono/node-server pg zod @hono/zod-validator jsonwebtoken winston winston-daily-rotate-file axios qs dayjs lodash

# 开发依赖
pnpm add -D @types/node tsx typescript @types/pg jest @types/jest ts-jest @swc/core @swc/jest dotenv dotenv-cli cross-env @types/jsonwebtoken @types/lodash esbuild rimraf

pnpm create @eslint/config

```

### 2.2 vscode 调试配置

> 新增 .vscode/settings.json

```json
{
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": "always",
    "source.fixAll": "always"
  }
}
```

> 运行 vscode 命令生成配置文件，菜单栏/Run/Add Configuration

```json
{
  // Use IntelliSense to learn about possible attributes.
  // Hover to view descriptions of existing attributes.
  // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug Jest Tests",
      "program": "${workspaceFolder}/node_modules/jest/bin/jest.js", // 或者直接指向 jest
      "args": [
        "--runInBand", // 关键：强制串行执行测试，便于调试
        "--watchAll=false", // 确保不是监视模式
        "--no-cache" // 避免缓存导致代码变化未生效
        // 可以添加更多 Jest 参数，例如 "--testNamePattern=<测试名称模式>" 来过滤特定测试
      ],
      "env": {
        "NODE_OPTIONS": "--experimental-vm-modules" // 替换 cross-env NODE_OPTIONS=--experimental-vm-modules
        // dotenv -e .env.dev 的功能：Jest 通常会自动加载 .env 文件，但指定自定义路径可能需要额外配置
        // 如果 jest 未自动加载 .env.dev，可以考虑使用 jest 的 `testEnvironmentOptions` 或 `setupFiles` 配置
      },
      "envFile": "${workspaceFolder}/.env.dev", // 使用 VSCode 的 envFile 属性直接注入环境变量，这通常比使用 dotenv 包更简单
      "console": "integratedTerminal",
      "internalConsoleOptions": "neverOpen",
      "windows": {
        "program": "${workspaceFolder}/node_modules/jest/bin/jest" // Windows 路径可能需要的调整
      },
      // 如果你的项目是 TypeScript，且使用了 ts-jest 或类似转换器，通常不需要在调试 Jest 时额外指定 --import=tsx
      // Jest 的转换器会处理 TypeScript 文件
      "skipFiles": ["<node_internals>/**"]
    },
    {
      "type": "node",
      "request": "launch",
      "name": "Launch Program",
      "skipFiles": ["<node_internals>/**"],
      "runtimeExecutable": "node",
      "runtimeArgs": ["--env-file=.env.dev", "--import=tsx", "--watch-path=./src"],
      "program": "${workspaceFolder}/src/app.ts",
      "sourceMaps": true
    }
  ]
}
```

### 2.3 环境变量

> .env,.env.dev

### 2.4 打包配置

> esbuild.config.mjs

### 2.5 eslint 配置

> eslint.config.mjs

### 2.6 jest 单元测试配置

> jest.config.mjs

### 2.7 package.json 脚本设置

### 2.8 tsconfig.json

### 2.9 上下文类型配置

> src/types/hono.d.ts

### 2.10 通用中间件

> 新建目录 src/middlewares

#### jwt

#### logger

#### pg

### 2.11 工具函数

> 新建目录 src/utils  
> 新建 validate-fail-handler.ts 用来处理接口参数校验

#### 校验参数函数

> 新建 error-handler.ts

#### 错误处理函数

#### 初始化表

### 2.12 业务模块

> 新建目录 modules, 新建一个 curd 模板  
> 新建 template 子目录，一个 model.ts, 一个 index.ts

#### model

#### index

#### index.spec.ts

### 2.13 项目入口 src/app.ts
